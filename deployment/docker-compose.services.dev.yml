x-service-defaults: &service-defaults
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M
  environment:
    JAVA_TOOL_OPTIONS: >-
      -XX:+UseContainerSupport
      -XX:MaxRAMPercentage=60
      -XX:InitialRAMPercentage=30
      -XX:MaxMetaspaceSize=96m
      -XX:+UseSerialGC
      -Dspring.jmx.enabled=false
    SPRING_PROFILES_ACTIVE: docker,dev
    LOGGING_LEVEL_ROOT: INFO
    LOGGING_LEVEL_RU_TISHEMBITOV: DEBUG

services:
  config-server:
    <<: *service-defaults
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 15s
      start_period: 20s

  eureka-server:
    <<: *service-defaults
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 15s
      start_period: 20s

  api-gateway:
    <<: *service-defaults
    deploy:
      resources:
        limits:
          memory: 384M
        reservations:
          memory: 192M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8222/actuator/health"]
      interval: 15s
      start_period: 20s

  user-service:
    <<: *service-defaults
    environment:
      SPRING_JPA_SHOW_SQL: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/actuator/health"]
      interval: 15s
      start_period: 30s

  content-service:
    <<: *service-defaults
    environment:
      SPRING_JPA_SHOW_SQL: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8020/actuator/health"]
      interval: 15s
      start_period: 30s

  storage-service:
    <<: *service-defaults
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 15s
      start_period: 30s

  chat-service:
    <<: *service-defaults
    environment:
      SPRING_JPA_SHOW_SQL: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/actuator/health"]
      interval: 15s
      start_period: 30s

  notification-service:
    <<: *service-defaults
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/actuator/health"]
      interval: 15s
      start_period: 30s

  search-service:
    <<: *service-defaults
    deploy:
      resources:
        limits:
          memory: 640M
        reservations:
          memory: 320M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8050/actuator/health"]
      interval: 15s
      start_period: 30s
